{% extends 'base.html' %}
{% load hitcount_tags %}

{% block extra_meta %}
    <meta property="og:title" content="{{ article.titre }}">
    <meta property="og:description" content="{{ article.contenu|striptags|truncatewords:30 }}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ absolute_url }}">
    {% if absolute_image_url %}
        <meta property="og:image" content="{{ absolute_image_url }}">
        <meta name="twitter:image" content="{{ absolute_image_url }}">
    {% endif %}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ article.titre }}">
    <meta name="twitter:description" content="{{ article.contenu|striptags|truncatewords:30 }}">
{% endblock extra_meta %}

{% block title %}
    {{ article.titre }} - MPP 2027
{% endblock title %}

{% block content %}

    <div class="article-layout">

        <main class="article-main-column">

            {% if article.image_banniere %}
                <div class="article-banner-container">
                    <img src="{{ article.image_banniere.url }}" alt="{{ article.titre }}" class="article-banner-img">
                </div>
            {% endif %}

            <header class="article-header">

                {% if article.statut == 'DRAFT' %}
                    <div style="background-color: #ff9800; color: black; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">

                        <div style="font-weight: bold; font-size: 0.95em;">
                            <i class="fas fa-pen-ruler"></i> MODE BROUILLON - Visible uniquement par vous
                        </div>

                        {% if user == article.auteur %}
                            <a href="{% url 'blog:article-update' slug=article.slug %}" class="btn-action outline" style="border-color: black; color: black; font-size: 0.9em; padding: 8px 15px;">
                                <i class="fas fa-pencil-alt"></i> Modifier cet article
                            </a>
                        {% endif %}

                    </div>
                {% endif %}

                <h1 class="article-title">{{ article.titre }}</h1>

                <div class="article-meta">
                    <span><i class="fas fa-user-circle"></i> {{ article.auteur.pseudo|default:"Rédaction" }}</span>
                    <span>&bull;</span>
                    <span>{{ article.date_creation|date:"d F Y" }}</span>
                    <span>&bull;</span>
                    <span><i class="fas fa-eye"></i> {% get_hit_count for article %} vues</span>
                </div>
            </header>

            <div class="article-content">
                {{ article.contenu|safe }}
            </div>

            {% if article.statut == 'PUBLISHED' %}
            <div class="share-footer" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="social-share" style="justify-content: flex-end;">
                    <span style="margin-right: 10px; font-weight: normal; opacity: 0.8;">Vous avez aimé ? Partagez :</span>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ absolute_url|urlencode }}" target="_blank" title="Facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://twitter.com/intent/tweet?url={{ absolute_url|urlencode }}&text={{ article.titre|urlencode }}" target="_blank" title="X (Twitter)">
                        <i class="fab fa-x-twitter"></i>
                    </a>
                </div>
            </div>
            {% endif %}

            <hr style="border-color: rgba(255,255,255,0.1); margin: 40px 0;">

            {% if article.statut == 'PUBLISHED' %}
            <section class="commentaires-section">
                <h3 style="color:white; margin-top:0; margin-bottom: 20px;">
                    <i class="far fa-comments"></i> Discussion ({{ commentaires.count }})
                </h3>

                <div class="comment-list">
                    {% for comm in commentaires %}
                        <div class="comment-item">

                            <div class="comment-avatar">
                                {% if comm.auteur %}
                                    <a href="{% url 'blog:auteur-profil' pk=comm.auteur.pk %}" class="comment-author-link" title="Voir le profil">
                                        {% if comm.auteur.profile_picture %}
                                            <img src="{{ comm.auteur.profile_picture.url }}" alt="Avatar">
                                        {% else %}
                                            <div class="default-avatar"><i class="fas fa-user"></i></div>
                                        {% endif %}
                                    </a>
                                {% else %}
                                    <div class="comment-author-link" style="cursor: default;">
                                        <div class="default-avatar"><i class="fas fa-user"></i></div>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="comment-body">
                                <strong>
                                    {% if comm.auteur %}
                                        <a href="{% url 'blog:auteur-profil' pk=comm.auteur.pk %}" class="comment-name-link">
                                            {{ comm.auteur.pseudo|default:"Utilisateur" }}
                                        </a>
                                    {% else %}
                                        <span style="color: #aaa; font-style: italic;">Utilisateur Supprimé</span>
                                    {% endif %}
                                </strong>

                                <span class="comment-date">{{ comm.date_creation|timesince }}</span>
                                <p>{{ comm.contenu }}</p>
                            </div>
                        </div>
                    {% empty %}
                        <p style="opacity: 0.6; text-align: center;">Soyez le premier à réagir à cet article !</p>
                    {% endfor %}
                </div>

                {% if user.is_authenticated %}
                    <form method="POST" class="comment-form" style="margin-top: 20px;">
                        {% csrf_token %}
                        {{ comment_form.contenu }}
                        <div style="text-align: right; margin-top: 10px;">
                            <button type="submit" class="btn-action red" style="border:none; cursor:pointer; padding: 10px 25px; font-size:1em;">
                                Publier
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="login-to-comment">
                        Vous devez être <a href="{% url 'users:login' %}">connecté</a> pour laisser un commentaire.
                    </div>
                {% endif %}

            </section>
            {% else %}
                <p style="text-align: center; color: rgba(255,255,255,0.5); margin-top: 30px; font-style: italic;">
                    Les commentaires et le partage sont désactivés en mode brouillon.
                </p>
            {% endif %}

        </main>


        <aside class="article-sidebar">

            <div class="sidebar-widget">
                <h4>Catégories</h4>
                <div class="tags-cloud">
                    {% for cat in article.categories.all %}
                        <a href="{% url 'blog:articles-par-categorie' slug_categorie=cat.slug %}" class="tag-pill">
                            {{ cat.nom }}
                        </a>
                    {% empty %}
                        <span style="font-size: 0.9em; opacity: 0.7;">Aucune catégorie</span>
                    {% endfor %}
                </div>
            </div>

            <div class="sidebar-widget author-widget" style="padding: 0;">

                {% if article.auteur %}
                    <a href="{% url 'blog:auteur-profil' pk=article.auteur.pk %}" class="author-card-link" style="padding: 20px;">
                        <div class="author-flex-container">
                            <div class="author-visual">
                                {% if article.auteur.profile_picture %}
                                    <img src="{{ article.auteur.profile_picture.url }}" class="author-img-large">
                                {% else %}
                                     <div class="author-img-large default"><i class="fas fa-user"></i></div>
                                {% endif %}
                            </div>
                            <div class="author-details">
                                <h5 class="author-name">{{ article.auteur.pseudo|default:"L'équipe MPP" }}</h5>
                                {% if article.auteur.description %}
                                    <p class="author-bio">{{ article.auteur.description|truncatewords:15 }}</p>
                                {% else %}
                                    <p class="author-bio">Voir le profil complet &rarr;</p>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                {% else %}
                    <div class="author-card-link" style="padding: 20px; cursor: default;">
                        <div class="author-flex-container">
                            <div class="author-visual">
                                 <div class="author-img-large default"><i class="fas fa-user-slash"></i></div>
                            </div>
                            <div class="author-details">
                                <h5 class="author-name">Utilisateur Supprimé</h5>
                                <p class="author-bio">Cet auteur n'est plus actif.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

            </div>

           <div class="sidebar-widget">
                <h4>Articles Suggérés</h4>
                <div class="suggested-list">
                    {% for suggestion in articles_suggeres %}
                        <a href="{% url 'blog:detail-article' slug=suggestion.slug %}" class="suggested-item">

                            <div class="suggested-thumb">
                                {% if suggestion.image_banniere %}
                                    <img src="{{ suggestion.image_banniere.url }}" alt="Miniature">
                                {% else %}
                                    <i class="fas fa-newspaper" style="font-size: 1.5em; color: rgba(255,255,255,0.5);"></i>
                                {% endif %}
                            </div>

                            <div class="suggested-info">
                                <span class="suggested-title">{{ suggestion.titre }}</span>
                            </div>
                        </a>
                    {% empty %}
                        <p style="font-size: 0.9em; opacity: 0.7;">Aucune suggestion pour le moment.</p>
                    {% endfor %}
                </div>
            </div>

        </aside>

    </div>

{% endblock content %}