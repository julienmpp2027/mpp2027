{% extends 'base.html' %}
{% load static %}

{% block title %}Simulateur Pouvoir d'Achat - MPP 2027{% endblock title %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="profile-header-card">
    <div class="profile-header-content">
        <div class="profile-avatar-xl default" style="background: #1E8E3E; border-color: white;">
            <i class="fas fa-shopping-basket"></i>
        </div>
        <div class="profile-info">
            <h1 class="profile-name">Simulateur Pouvoir d'Achat</h1>
            <p class="profile-meta">
                Calculez l'impact réel du programme : RDC, réforme fiscale et TVA.
            </p>
        </div>
    </div>
</div>

<div class="container simu-container">
    <div class="simu-grid">

        <div class="simu-col-left">
            <div class="dashboard-card full-height">
                <h3 class="card-title"><i class="fas fa-user-tag"></i> Votre Profil</h3>

                <div class="form-group">
                    <label>Statut principal</label>
                    <div class="radio-group">
                        <label class="radio-card">
                            <input type="radio" name="statut" value="actif" checked onchange="calculerPA()">
                            <span class="radio-content"><i class="fas fa-briefcase"></i> Actif</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="statut" value="etudiant" onchange="calculerPA()">
                            <span class="radio-content"><i class="fas fa-graduation-cap"></i> Étudiant</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="statut" value="retraite" onchange="calculerPA()">
                            <span class="radio-content"><i class="fas fa-umbrella-beach"></i> Retraité</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Revenu Net Mensuel du Foyer (€)</label>
                    <input type="number" id="revenu" value="2000" class="input-simu" oninput="calculerPA()">
                    <div class="help-text">Salaires nets, pensions et autres revenus.</div>
                </div>

                <div class="form-group">
                    <label>Composition du foyer</label>
                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div style="flex:1;">
                            <label style="font-size:0.9em;">Adultes</label>
                            <input type="number" id="adultes" value="1" min="1" max="5" class="input-simu" oninput="calculerPA()">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.9em;">Enfants</label>
                            <input type="number" id="enfants" value="0" min="0" max="10" class="input-simu" oninput="calculerPA()">
                        </div>
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="parent_isole" onchange="calculerPA()">
                        <label for="parent_isole">Je suis parent isolé (+300€ aide)</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Profil Consommation (% du revenu dépensé hors logement)</label>
                    <input type="range" id="conso" min="10" max="100" value="90" class="range-simu" oninput="calculerPA()">
                    <div class="range-labels">
                        <span>10%</span>
                        <span id="conso-val" class="main-color bold">90%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="simu-col-right sticky-column">

            <div class="dashboard-card center-text" id="card-resultat">
                <h2 class="card-subtitle">VOTRE RESTE À VIVRE RÉEL</h2>
                <div class="main-pension-group">
                    <span id="delta-montant" class="huge-pension">+ 0 €</span>
                    <span class="per-month">/ mois</span>
                </div>
                <div id="delta-text" style="font-weight: bold; margin-bottom: 25px;">Gain de pouvoir d'achat</div>

                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px; margin-top: 15px;">
                    <div style="font-size: 0.9em; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">Soit un total de</div>
                    <div id="total-mpp-display" style="font-size: 2.5em; font-weight: 800; color: var(--couleur-principale);">0 €</div>
                </div>
            </div>

            <div class="dashboard-card" style="padding-bottom: 0; overflow: hidden;">
                <div class="header-row">
                    <div class="col-label"></div>
                    <div class="col-value header-text">ACTUEL</div>
                    <div class="col-value header-text tertiaire-color">MPP 2027</div>
                </div>

                <div class="data-row">
                    <div class="col-label grey-color">RDC & Aides :</div>
                    <div class="col-value light-grey">--</div>
                    <div class="col-value green bold" id="mpp-rdc">+ 0 €</div>
                </div>

                <div class="data-row">
                    <div class="col-label grey-color">Impôt Revenu :</div>
                    <div class="col-value" id="actuel-impot">- 0 €</div>
                    <div class="col-value tertiaire-color bold" id="mpp-impot">- 0 €</div>
                </div>

                <div class="data-row tva-row">
                    <div class="col-label tertiaire-color"><i class="fas fa-shopping-cart"></i> Surcoût TVA :</div>
                    <div class="col-value"></div>
                    <div class="col-value tertiaire-color bold" id="mpp-surcout-tva">- 0 €</div>
                </div>

                <div class="footer-row">
                    <div class="col-label bold">Pouvoir d'achat :</div>
                    <div class="col-value bold" id="actuel-final">0 €</div>
                    <div class="col-value bold" id="mpp-final" style="font-size: 1.2em;">0 €</div>
                </div>
            </div>

            <div class="dashboard-card action-card">
                <div class="bold main-color" style="margin-bottom: 10px;">Partager ou Sauvegarder</div>
                <div class="social-buttons-group">
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="btn-social fb">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" id="share-x" target="_blank" class="btn-social x">
                        <i class="fab fa-x-twitter"></i>
                    </a>
                    <button onclick="telechargerPDF()" class="btn-social pdf">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="pdf-template-container" style="position: absolute; left: -9999px; top: 0;">
    <div id="pdf-template" style="width: 794px; padding: 40px; background: white; font-family: sans-serif; color: #333;">
        <div style="border-bottom: 3px solid #1E8E3E; padding-bottom: 20px; margin-bottom: 30px; display:flex; justify-content:space-between; align-items:center;">
            <img src="{% static 'img/mon_logo.png' %}" style="height: 60px;">
            <div style="text-align: right;">
                <h1 style="margin: 0; color: #1C3047; font-size: 24px;">Bilan Pouvoir d'Achat</h1>
                <p style="margin: 5px 0 0; color: #666;">Programme MPP 2027</p>
            </div>
        </div>
        <div style="background: #f4f7fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin-top: 0; color: #1C3047;">1. Votre Foyer</h3>
            <ul style="list-style: none; padding: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <li><strong>Revenu Net :</strong> <span id="pdf-revenu"></span> €</li>
                <li><strong>Composition :</strong> <span id="pdf-compo"></span></li>
                <li><strong>Statut :</strong> <span id="pdf-statut"></span></li>
                <li><strong>Consommation :</strong> <span id="pdf-conso"></span></li>
            </ul>
        </div>
        <h3 style="color: #1E8E3E;">2. Comparatif Mensuel</h3>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
                <tr style="background: #1C3047; color: white;">
                    <th style="padding: 12px; text-align: left;">Poste</th>
                    <th style="padding: 12px; text-align: right;">Système Actuel</th>
                    <th style="padding: 12px; text-align: right; background: #C33037;">Avec MPP 2027</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">Revenus / RDC</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">--</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; color: #1E8E3E; font-weight: bold;"><span id="pdf-rdc"></span></td>
                </tr>
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">Impôt sur le revenu</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><span id="pdf-impot-actuel"></span></td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><span id="pdf-impot-mpp"></span></td>
                </tr>
                <tr style="background: #FFF5F5;">
                    <td style="padding: 12px; border-bottom: 1px solid #eee; color: #C33037;"><i>Impact Hausse TVA</i></td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">--</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; color: #C33037;"><span id="pdf-tva"></span></td>
                </tr>
                <tr style="font-weight: bold; font-size: 1.2em; background: #eee;">
                    <td style="padding: 15px;">POUVOIR D'ACHAT RÉEL</td>
                    <td style="padding: 15px; text-align: right;"><span id="pdf-final-actuel"></span></td>
                    <td style="padding: 15px; text-align: right; color: #1C3047;"><span id="pdf-final-mpp"></span></td>
                </tr>
            </tbody>
        </table>
        <div style="text-align: center; padding: 30px; border: 2px solid #ddd; border-radius: 10px;">
            <div style="font-size: 1.2em; color: #666;">Bilan de l'opération</div>
            <div style="font-size: 3em; font-weight: 800; margin: 15px 0;" id="pdf-delta"></div>
            <div style="font-size: 1.1em;" id="pdf-delta-text"></div>
        </div>
        <p style="margin-top: 40px; text-align: center; font-size: 0.8em; color: #999;">Simulation générée sur mpp2027.fr le <span id="pdf-date"></span></p>
    </div>
</div>

<script>
    function calculerPA() {
        let revenu = document.getElementById('revenu').value;
        let adultes = document.getElementById('adultes').value;
        let enfants = document.getElementById('enfants').value;
        let conso = document.getElementById('conso').value;
        let statut = document.querySelector('input[name="statut"]:checked').value;
        let parentIsole = document.getElementById('parent_isole').checked;

        document.getElementById('conso-val').innerText = conso + "%";

        let url = `{% url 'simulateur:api_calcul_pa' %}?revenu=${revenu}&adultes=${adultes}&enfants=${enfants}&conso=${conso}&statut=${statut}&parent_isole=${parentIsole}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById('actuel-impot').innerText = "- " + data.actuel.impot + " €";
                document.getElementById('actuel-final').innerText = data.actuel.final.toLocaleString() + " €";

                document.getElementById('mpp-rdc').innerText = "+ " + data.mpp.rdc + " €";
                document.getElementById('mpp-impot').innerText = "- " + data.mpp.impot + " €";
                document.getElementById('mpp-surcout-tva').innerText = "- " + data.mpp.surcout_tva + " €";
                document.getElementById('mpp-final').innerText = data.mpp.final.toLocaleString() + " €";
                document.getElementById('total-mpp-display').innerText = data.mpp.final.toLocaleString() + " €";

                let deltaEl = document.getElementById('delta-montant');
                let card = document.getElementById('card-resultat');
                let text = document.getElementById('delta-text');
                let sign = data.delta.is_positif ? "+" : "";

                deltaEl.innerText = sign + " " + data.delta.valeur + " €";

                if (data.delta.is_positif) {
                    deltaEl.style.color = "#1E8E3E";
                    text.innerText = "Gain net mensuel";
                    text.style.color = "#1E8E3E";
                    card.style.borderLeft = "5px solid #1E8E3E";
                } else {
                    deltaEl.style.color = "#C33037";
                    text.innerText = "Effort contributif";
                    text.style.color = "#C33037";
                    card.style.borderLeft = "5px solid #C33037";
                }

                let shareText = `Simulation MPP 2027 : Mon pouvoir d'achat évolue de ${sign}${data.delta.valeur}€ par mois. Faites le test !`;
                let twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent("{{ request.build_absolute_uri }}")}`;
                document.getElementById('share-x').href = twitterUrl;
            })
            .catch(error => console.error('Erreur:', error));
    }

    function telechargerPDF() {
        document.getElementById('pdf-revenu').innerText = document.getElementById('revenu').value;
        document.getElementById('pdf-compo').innerText = document.getElementById('adultes').value + " adulte(s), " + document.getElementById('enfants').value + " enfant(s)";

        let statut = document.querySelector('input[name="statut"]:checked').nextElementSibling.innerText.trim();
        if(document.getElementById('parent_isole').checked) statut += " (Parent isolé)";
        document.getElementById('pdf-statut').innerText = statut;
        document.getElementById('pdf-conso').innerText = document.getElementById('conso').value + "% du revenu";

        document.getElementById('pdf-rdc').innerText = document.getElementById('mpp-rdc').innerText;
        document.getElementById('pdf-impot-actuel').innerText = document.getElementById('actuel-impot').innerText;
        document.getElementById('pdf-impot-mpp').innerText = document.getElementById('mpp-impot').innerText;
        document.getElementById('pdf-tva').innerText = document.getElementById('mpp-surcout-tva').innerText;
        document.getElementById('pdf-final-actuel').innerText = document.getElementById('actuel-final').innerText;
        document.getElementById('pdf-final-mpp').innerText = document.getElementById('mpp-final').innerText;

        let deltaEl = document.getElementById('delta-montant');
        let pdfDelta = document.getElementById('pdf-delta');
        pdfDelta.innerText = deltaEl.innerText;
        pdfDelta.style.color = deltaEl.style.color;
        document.getElementById('pdf-delta-text').innerText = document.getElementById('delta-text').innerText;
        document.getElementById('pdf-date').innerText = new Date().toLocaleDateString('fr-FR');

        const { jsPDF } = window.jspdf;
        const element = document.getElementById("pdf-template");

        html2canvas(element, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = 210;
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            pdf.save("Bilan-PA-MPP2027.pdf");
        });
    }

    document.addEventListener("DOMContentLoaded", calculerPA);
</script>

<style>
    /* ALIGNEMENT GRID & FLEXBOX : C'est ici que la magie opère */
    .simu-container { max-width: 1100px; margin: 0 auto 60px; }

    /* On force l'étirement des colonnes pour qu'elles aient la même hauteur */
    .simu-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: stretch; /* CRUCIAL : force l'égalité de hauteur */
    }

    /* La colonne de gauche devient une Flexbox verticale pour étirer sa carte */
    .simu-col-left {
        display: flex;
        flex-direction: column;
    }

    /* La carte de gauche prend tout l'espace disponible */
    .full-height {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* ou space-between si vous voulez aérer */
    }

    /* La colonne de droite reste sticky */
    .simu-col-right.sticky-column {
        position: sticky;
        top: 20px;
        height: fit-content;
    }

    /* CSS Tableau & Alignement */
    .header-row, .data-row, .footer-row {
        display: flex;
        align-items: center;
        padding: 8px 15px;
    }
    .col-label { flex: 2; text-align: left; font-size: 0.95em; }
    .col-value { flex: 1; text-align: right; white-space: nowrap; }
    .header-text { font-weight: bold; font-size: 0.9em; letter-spacing: 0.5px; }

    .tva-row { background: #FFF5F5; margin: 5px 0; border-radius: 5px; }

    /* LE FOND GRIS POUR LE TOTAL */
    .footer-row {
        background: #37474F; /* Gris Anthracite (Bleu Gris très sombre) */
        color: white;
        margin: 15px -20px -20px -20px;
        padding: 15px 35px;
    }

    /* Autres Styles */
    .card-title { margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 25px; }
    .input-simu { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; color: #333; }
    .range-simu { width: 100%; accent-color: var(--couleur-principale); margin: 10px 0; }
    .range-labels { display: flex; justify-content: space-between; font-size: 0.9em; color: #666; }
    .center-text { text-align: center; }
    .huge-pension { font-size: 3.5em; font-weight: 800; display:block; }
    .per-month { font-size: 1.2em; color: #666; }

    .light-grey { color: #ccc; }
    .grey-color { color: #666; }
    .green { color: #1E8E3E; }
    .tertiaire-color { color: var(--couleur-tertiaire); }
    .main-color { color: var(--couleur-principale); }
    .bold { font-weight: bold; }
    .help-text { font-size: 0.85em; color: #777; margin-top: 5px; font-style: italic; }

    .radio-group { display: flex; gap: 10px; margin-top: 5px; }
    .radio-card { flex: 1; position: relative; cursor: pointer; }
    .radio-card input { display: none; }
    .radio-content { display: block; text-align: center; padding: 10px 5px; border: 2px solid #ddd; border-radius: 8px; color: #666; transition: all 0.2s; font-size: 0.9em; }
    .radio-card input:checked + .radio-content { border-color: var(--couleur-tertiaire); color: var(--couleur-tertiaire); background: #FFF5F5; font-weight: bold; }
    .checkbox-container { display: flex; align-items: center; gap: 10px; margin-top: 10px; background: #f9f9f9; padding: 8px; border-radius: 5px; }
    .checkbox-container input { width: 18px; height: 18px; accent-color: var(--couleur-tertiaire); }

    .action-card { padding: 20px; text-align: center; }
    .social-buttons-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .btn-social { display: inline-flex; align-items: center; justify-content: center; width: 45px; height: 45px; border-radius: 50%; color: white; text-decoration: none; font-size: 1.2em; transition: transform 0.2s; border: none; cursor: pointer; }
    .btn-social:hover { transform: scale(1.1); filter: brightness(1.1); }
    .btn-social.fb { background: #1877F2; }
    .btn-social.x { background: #000; }
    .btn-social.pdf { background: #C33037; width: auto; padding: 0 20px; border-radius: 8px; font-size: 1em; gap: 8px; height: 45px; }

    @media (max-width: 900px) { .simu-grid { grid-template-columns: 1fr; } }
</style>

{% endblock content %}
